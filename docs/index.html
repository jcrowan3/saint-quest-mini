<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data:;">
  <title>Saint Quest</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet" crossorigin>
  <style>
    :root {
      --primary-dark: #1a0a2e;
      --secondary-dark: #2d1b4d;
      --accent-gold: #d4af37;
      --accent-blue: #4a90e2;
      --accent-purple: #9c27b0;
      --text-light: #f0f0f0;
      --text-dark: #121212;
      --card-bg: rgba(255, 255, 255, 0.1);
      --border-radius: 12px;
      --transition: all 0.4s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Lato', sans-serif;
      background: linear-gradient(135deg, var(--primary-dark), var(--secondary-dark));
      color: var(--text-light);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      animation: fadeIn 1s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    h1, h2, h3 {
      font-family: 'Cinzel', serif;
      color: var(--accent-gold);
      text-align: center;
    }

    .container {
      max-width: 900px;
      width: 100%;
      margin: 0 auto;
    }

    .screen {
      display: none;
      animation: slideIn 0.5s ease-out;
      background: var(--card-bg);
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }

    .screen.active {
      display: block;
    }

    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .story-card {
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: var(--border-radius);
      margin-bottom: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: var(--transition);
    }

    .story-card:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-5px);
    }

    .virtue-badge {
      display: inline-block;
      padding: 6px 12px;
      margin: 5px;
      border-radius: 50px;
      font-size: 0.9em;
      font-weight: bold;
      transition: var(--transition);
    }

    .v-faith { background-color: #2196F3; color: white; }
    .v-mercy { background-color: #4CAF50; color: white; }
    .v-courage { background-color: #F44336; color: white; }
    .v-wisdom { background-color: #9C27B0; color: white; }

    .progress-container {
      margin: 20px 0;
    }

    .progress-bar {
      height: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      overflow: hidden;
    }

    .progress {
      height: 100%;
      background: var(--accent-gold);
      border-radius: 5px;
      transition: width 0.5s ease;
    }

    .btn {
      padding: 12px 24px;
      margin: 10px 5px;
      border: none;
      border-radius: var(--border-radius);
      background: var(--accent-gold);
      color: var(--text-dark);
      font-family: 'Cinzel', serif;
      font-size: 1.1em;
      cursor: pointer;
      transition: var(--transition);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: bold;
    }

    .btn:hover {
      background: #f5d64a;
      transform: scale(1.05);
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-secondary {
      background: transparent;
      border: 2px solid var(--accent-gold);
      color: var(--accent-gold);
    }

    .btn-secondary:hover {
      background: rgba(212, 175, 55, 0.2);
    }

    .columns {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .column {
      flex: 1;
      min-width: 200px;
    }

    .saint-card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .saint-card:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-5px);
    }

    .saint-card h3 {
      margin: 10px 0;
    }

    .avatar {
      font-size: 3em;
      margin: 10px 0;
    }

    .footer {
      margin-top: 30px;
      text-align: center;
      font-size: 0.9em;
      color: rgba(255, 255, 255, 0.6);
    }

    /* Difficulty selector */
    .difficulty-selector {
      text-align: center;
      margin: 20px 0;
    }
    .difficulty-selector h3 {
      margin-bottom: 12px;
    }
    .diff-btn {
      padding: 10px 20px;
      margin: 5px;
      border: 2px solid var(--accent-gold);
      border-radius: 8px;
      background: transparent;
      color: var(--accent-gold);
      font-family: 'Cinzel', serif;
      font-size: 0.95em;
      cursor: pointer;
      transition: var(--transition);
    }
    .diff-btn:hover, .diff-btn.active {
      background: var(--accent-gold);
      color: var(--text-dark);
    }
    .timer-bar {
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      margin: 10px 0;
      overflow: hidden;
      display: none;
    }
    .timer-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444);
      border-radius: 2px;
      transition: width 0.1s linear;
      width: 100%;
    }
    .hint-text {
      color: #fbbf24;
      font-style: italic;
      margin-top: 8px;
      font-size: 0.9em;
      display: none;
    }

    /* Particles */
    .particle {
      position: fixed;
      pointer-events: none;
      font-size: 16px;
      z-index: 999;
      animation: particleFade 1s ease-out forwards;
    }
    @keyframes particleFade {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-80px) scale(0.5); }
    }

    /* Screen shake */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-8px); }
      40% { transform: translateX(8px); }
      60% { transform: translateX(-5px); }
      80% { transform: translateX(5px); }
    }
    .shake {
      animation: shake 0.4s ease-in-out;
    }

    /* Radar chart */
    .radar-container {
      text-align: center;
      margin: 20px 0;
    }
    .radar-container canvas {
      max-width: 300px;
      max-height: 300px;
    }

    .balloons {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
      opacity: 0;
    }

    .balloon {
      position: absolute;
      font-size: 24px;
      animation: float 10s linear infinite;
    }

    @keyframes float {
      0% {
        transform: translateY(100vh) rotate(0deg);
      }
      100% {
        transform: translateY(-100px) rotate(360deg);
      }
    }

    .question-container {
      margin: 20px 0;
    }

    .radio-group {
      margin: 15px 0;
    }

    .radio-option {
      display: block;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      cursor: pointer;
      transition: var(--transition);
    }

    .radio-option:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .radio-option input {
      margin-right: 10px;
    }

    .result {
      padding: 15px;
      border-radius: var(--border-radius);
      margin: 15px 0;
      text-align: center;
    }

    .correct {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid #4CAF50;
    }

    .incorrect {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid #F44336;
    }

    /* Streak display */
    .streak-display {
      text-align: center;
      font-family: 'Cinzel', serif;
      color: var(--accent-gold);
      font-size: 1.2em;
      margin: 10px 0;
      min-height: 1.5em;
      transition: all 0.3s ease;
    }
    .streak-fire {
      animation: streakPulse 0.5s ease-in-out;
    }
    @keyframes streakPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.3); }
    }

    /* Achievement styles */
    .achievement-toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #2d1b4d, #4a2d7a);
      border: 2px solid var(--accent-gold);
      border-radius: 12px;
      padding: 15px 25px;
      display: flex;
      align-items: center;
      gap: 15px;
      z-index: 2000;
      animation: toastSlideIn 0.5s ease-out, toastFadeOut 0.5s 2.5s ease-in forwards;
      box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3);
      color: var(--text-light);
    }
    @keyframes toastSlideIn {
      from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    @keyframes toastFadeOut {
      to { opacity: 0; transform: translateX(-50%) translateY(-30px); }
    }
    .achievements-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    .achievement-badge {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      margin: 5px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      min-width: 80px;
      font-size: 0.8em;
      transition: var(--transition);
    }
    .achievement-badge.unlocked {
      border-color: var(--accent-gold);
      background: rgba(212, 175, 55, 0.1);
    }
    .achievement-badge.locked {
      opacity: 0.4;
      filter: grayscale(100%);
    }

    /* High score badge on saint cards */
    .high-score-badge {
      color: var(--accent-gold);
      font-size: 0.85em;
      margin-top: 8px;
      font-weight: bold;
    }
    .saint-card { position: relative; }

    /* Intro screen animation */
    #intro-screen .story-card {
      animation: introFadeIn 1s ease-out;
    }
    #intro-avatar {
      animation: introAvatarBounce 1.5s ease-in-out;
    }
    @keyframes introAvatarBounce {
      0% { transform: scale(0) rotate(-10deg); opacity: 0; }
      50% { transform: scale(1.2) rotate(5deg); opacity: 1; }
      100% { transform: scale(1) rotate(0deg); }
    }
    @keyframes introFadeIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Daily challenge */
    .daily-section {
      text-align: center;
      margin: 20px 0;
      padding: 15px;
      border: 1px dashed var(--accent-gold);
      border-radius: var(--border-radius);
      background: rgba(212, 175, 55, 0.05);
    }
    .daily-status {
      font-size: 0.85em;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 8px;
    }

    /* Review section */
    .review-card {
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
      background: rgba(255, 255, 255, 0.05);
    }
    .review-card.review-correct { border-left: 4px solid #4CAF50; }
    .review-card.review-wrong { border-left: 4px solid #F44336; }

    @media (max-width: 768px) {
      .columns {
        flex-direction: column;
      }

      .avatar {
        font-size: 2em;
      }

      h1 {
        font-size: 2em;
      }

      h2 {
        font-size: 1.5em;
      }
    }
  
    /* Matching Challenge */
    .match-grid { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin: 15px 0; }
    .match-column { flex: 1; min-width: 120px; display: flex; flex-direction: column; gap: 10px; }
    .match-item { padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; text-align: center; min-height: 44px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; border: 2px solid transparent; }
    .match-item:hover { background: rgba(212, 175, 55, 0.2); }
    .match-item.selected { border-color: var(--accent-gold); background: rgba(212, 175, 55, 0.15); }
    .match-item.matched { background: rgba(46, 139, 87, 0.4); border-color: #2e8b57; pointer-events: none; }
    .match-item.wrong-flash { background: rgba(220, 20, 60, 0.4); border-color: #dc143c; }

    /* Timeline Challenge */
    .timeline-events { display: flex; flex-direction: column; gap: 10px; margin: 15px 0; }
    .timeline-slot { padding: 12px; background: rgba(255,255,255,0.05); border: 2px dashed rgba(212,175,55,0.3); border-radius: 8px; min-height: 44px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: all 0.2s; }
    .timeline-slot.filled { border-style: solid; border-color: var(--accent-gold); background: rgba(212,175,55,0.1); }
    .timeline-slot .slot-num { font-weight: bold; color: var(--accent-gold); margin-right: 10px; min-width: 24px; }
    .timeline-pool { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; justify-content: center; }
    .timeline-event-btn { padding: 10px 14px; background: rgba(255,255,255,0.1); border: 2px solid transparent; border-radius: 8px; cursor: pointer; color: var(--text-light); font-family: inherit; font-size: 0.9em; transition: all 0.2s; }
    .timeline-event-btn:hover { background: rgba(212,175,55,0.2); border-color: var(--accent-gold); }
    .timeline-event-btn.placed { opacity: 0.3; pointer-events: none; }
    .timeline-result-correct { border-color: #2e8b57 !important; background: rgba(46,139,87,0.2) !important; }
    .timeline-result-wrong { border-color: #dc143c !important; background: rgba(220,20,60,0.2) !important; }

  </style>
</head>
<body>
  <div class="container">
    <h1>‚öîÔ∏è Saint Quest üõ°Ô∏è</h1>

    <!-- Select Screen -->
    <div id="select-screen" class="screen active">
      <h2>Choose Your Hero</h2>
      <div class="daily-section">
        <button class="btn" id="daily-challenge-btn" onclick="startDailyChallenge()">üìÖ Daily Challenge</button>
        <p class="daily-status" id="daily-status"></p>
      </div>
      <div class="difficulty-selector">
        <h3>‚öîÔ∏è Difficulty</h3>
        <button class="diff-btn active" onclick="setDifficulty('easy',this)">Easy</button>
        <button class="diff-btn" onclick="setDifficulty('normal',this)">Normal</button>
        <button class="diff-btn" onclick="setDifficulty('hard',this)">Hard</button>
      </div>
      <div class="columns" id="saint-grid"></div>
      <div id="achievements-display" style="margin-top: 20px;"></div>
    </div>

    <!-- Intro Screen -->
    <div id="intro-screen" class="screen">
      <div class="story-card" style="text-align: center;">
        <div id="intro-avatar" style="font-size: 120px; margin: 20px 0;"></div>
        <h2 id="intro-name"></h2>
        <p id="intro-quote" style="font-style: italic; font-size: 1.2em; line-height: 1.6; margin: 20px 0; color: var(--accent-gold);"></p>
        <div id="intro-virtues"></div>
        <button class="btn" onclick="beginJourney()" style="margin-top: 20px;">Begin Journey</button>
      </div>
    </div>

    <!-- Play Screen -->
    <div id="play-screen" class="screen">
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress" id="progress-bar"></div>
        </div>
        <p id="progress-text" style="text-align: center;"></p>
      </div>

      <div class="story-card">
        <h2 id="quest-title">Loading...</h2>
        <p id="quest-story" style="font-size: 1.2em; line-height: 1.6;"></p>
      </div>

      <div class="streak-display" id="streak-display"></div>
      <div class="timer-bar" id="timer-bar"><div class="timer-fill" id="timer-fill"></div></div>
      <div class="question-container" id="question-container">
        <!-- Questions rendered here -->
      </div>
      <div class="hint-text" id="hint-text"></div>

      <div class="columns">
        <div class="column">
          <div class="story-card">
            <h3>Profile</h3>
            <div id="profile-content">
              <!-- Profile rendered here -->
            </div>
          </div>
        </div>
      </div>

      <button id="continue-btn" class="btn btn-secondary" style="display: none;" onclick="nextQuest()">Continue</button>
    </div>

    <!-- Done Screen -->
    <div id="done-screen" class="screen">
      <div class="story-card" style="text-align: center; border-color: gold; background-color: #fffef0;">
        <h1>Sainthood Unlocked!</h1>
        <div style="font-size: 80px;">üòá</div>
        <p style="font-size: 1.3em;">You have completed the journey of <span id="saint-name"></span>.</p>
        <p><i>"Start by doing what's necessary; then do what's possible; and suddenly you are doing the impossible."</i></p>
      </div>

      <p id="score-display" style="font-size: 1.5em; color: var(--accent-gold); text-align: center; margin: 15px 0;"></p>
      <p id="new-record" style="color: #10b981; font-weight: bold; text-align: center; display: none;">üéâ New Personal Best!</p>
      <p id="streak-summary" style="text-align: center; margin: 10px 0;"></p>

      <h3>Final Virtue Profile</h3>
      <div class="radar-container"><canvas id="radar-canvas" width="300" height="300"></canvas></div>
      <div id="final-profile"></div>

      <div id="done-achievements" style="margin: 20px 0;"></div>
      <div id="daily-share" style="text-align: center; margin: 15px 0;"></div>

      <h3 style="cursor: pointer; margin-top: 20px;" onclick="toggleReview()">üìã Review Answers ‚ñº</h3>
      <div id="review-section" style="display: none; margin-top: 10px;"></div>

      <button class="btn" onclick="resetGame()">Start New Journey</button>
    </div>
  </div>

  <div class="balloons" id="balloons"></div>

  <div class="footer">
    &copy; Saint Quest Game | Faithful to Catholic Virtues
  </div>

  <script>
    // Game Data (embedded)
    const saints = [
      { "id": "francis", "name": "St. Francis of Assisi", "avatar": "üê∫", "virtues": ["Mercy", "Courage"] },
      { "id": "carlo", "name": "St. Carlo Acutis", "avatar": "üíª", "virtues": ["Wisdom", "Faith"] },
      { "id": "joan", "name": "St. Joan of Arc", "avatar": "üó°Ô∏è", "virtues": ["Courage", "Faith"] },
      { "id": "aquinas", "name": "St. Thomas Aquinas", "avatar": "üìö", "virtues": ["Wisdom", "Faith"] },
      { "id": "teresa", "name": "St. Teresa of Calcutta", "avatar": "üïäÔ∏è", "virtues": ["Mercy", "Faith"] },
      { "id": "patrick", "name": "St. Patrick", "avatar": "‚òòÔ∏è", "virtues": ["Courage", "Faith"] },
      { "id": "therese", "name": "St. Th√©r√®se of Lisieux", "avatar": "üåπ", "virtues": ["Faith", "Mercy"] },
      { "id": "frassati", "name": "Bl. Pier Giorgio Frassati", "avatar": "‚õ∞Ô∏è", "virtues": ["Courage", "Mercy"] }
    ];

    const quests = {
  "francis": [
    {
      "title": "The Wolf of Gubbio",
      "story": "The town of Gubbio lives in terror. A massive wolf prowls the countryside, attacking livestock and even threatening people who venture beyond the walls. The townspeople beg Francis for help, expecting him to call for hunters ‚Äî but Francis has a different plan.",
      "challenge": {
        "type": "dilemma",
        "prompt": "The wolf snarls at you from the edge of the forest. What do you do?",
        "options": [
          "Walk toward it unarmed, speaking words of peace",
          "Organize the townspeople to drive it away",
          "Set traps around the village perimeter",
          "Pray from a safe distance and hope it leaves"
        ],
        "answer_index": 0
      },
      "reward": {
        "Mercy": 2,
        "Courage": 1
      }
    },
    {
      "title": "Sermon to the Birds",
      "story": "Walking through the Spoleto Valley, Francis notices a vast flock of birds gathered in the trees and fields. His companions want to press on, but Francis feels called to stop. He begins to preach to the birds about gratitude for God's gifts ‚Äî and remarkably, they fall silent and listen.",
      "challenge": {
        "type": "trivia",
        "question": "What is St. Francis of Assisi the patron saint of?",
        "choices": [
          "Animals and ecology",
          "Lost causes",
          "Travelers",
          "Musicians"
        ],
        "answer_index": 0
      },
      "reward": {
        "Mercy": 1,
        "Courage": 1
      }
    },
    {
      "title": "Rebuild My Church",
      "story": "Praying before a crucifix in the crumbling chapel of San Damiano, Francis hears a voice: 'Francis, go and repair my church, which as you see is falling into ruin.' He takes it literally at first, hauling stones to rebuild the chapel ‚Äî but gradually understands the deeper call to renew the entire Church.",
      "challenge": {
        "type": "dilemma",
        "prompt": "You feel called to rebuild something broken. What is the best first step?",
        "options": [
          "Start with small acts of love and service",
          "Wait for someone more qualified to lead",
          "Seek recognition for your willingness",
          "Debate the best approach endlessly"
        ],
        "answer_index": 0
      },
      "reward": {
        "Courage": 2,
        "Mercy": 1
      }
    },
    {
      "title": "The Stigmata",
      "story": "On Mount La Verna in 1224, during an intense period of prayer and fasting, Francis has a vision of a seraph ‚Äî a six-winged angel bearing the image of Christ crucified. When the vision fades, Francis discovers he bears the wounds of Christ on his hands, feet, and side ‚Äî the first recorded stigmata.",
      "challenge": {
        "type": "trivia",
        "question": "In what year did Francis of Assisi receive the stigmata on Mount La Verna?",
        "choices": [
          "1224",
          "1210",
          "1226",
          "1209"
        ],
        "answer_index": 0
      },
      "reward": {
        "Faith": 2,
        "Courage": 1
      }
    },
    {
      "title": "Lady Poverty",
      "story": "Born to a wealthy cloth merchant, the young Francis loved fine clothes and parties. After a profound conversion, he stripped off his expensive garments in the town square, renouncing his inheritance before the bishop and his own father. He chose radical poverty as his bride ‚Äî 'Lady Poverty' ‚Äî owning nothing so he could receive everything from God.",
      "challenge": {
        "type": "trivia",
        "question": "What was Francis's father's profession before Francis renounced his wealth?",
        "choices": [
          "Cloth merchant",
          "Blacksmith",
          "Farmer",
          "Nobleman"
        ],
        "answer_index": 0
      },
      "reward": {
        "Mercy": 1,
        "Courage": 2
      }
    },
    {
      "title": "Saints and Their Signs",
      "story": "Throughout history, each saint has been associated with particular symbols, animals, or miracles that reflect their life and mission. Can you match these saints to their most famous associations?",
      "challenge": {
        "type": "matching",
        "prompt": "Match each saint to their famous association.",
        "pairs": [
          {
            "left": "St. Francis",
            "right": "Preaching to birds"
          },
          {
            "left": "St. Patrick",
            "right": "Driving out serpents"
          },
          {
            "left": "St. Joan of Arc",
            "right": "Sword of Fierbois"
          },
          {
            "left": "Carlo Acutis",
            "right": "Eucharistic miracles website"
          },
          {
            "left": "Thomas Aquinas",
            "right": "Summa Theologica"
          }
        ]
      },
      "reward": {
        "Mercy": 1,
        "Wisdom": 1
      }
    }
  ],
  "carlo": [
    {
      "title": "The Digital Evangelist",
      "story": "At just 11 years old, Carlo Acutis began creating a comprehensive catalog of documented Eucharistic miracles around the world, building a website to share them. While other kids his age were playing video games, Carlo was teaching himself web design and programming to spread the faith ‚Äî making him a pioneer of digital evangelization.",
      "challenge": {
        "type": "trivia",
        "question": "What did Carlo Acutis famously catalog on his website?",
        "choices": [
          "Eucharistic miracles",
          "Lives of the saints",
          "Marian apparitions",
          "Biblical archaeology"
        ],
        "answer_index": 0
      },
      "reward": {
        "Faith": 2,
        "Wisdom": 1
      }
    },
    {
      "title": "Coding for the Kingdom",
      "story": "Carlo believed technology was a gift from God that should be used to bring people closer to Him. He built websites, edited videos, and created digital content about the faith ‚Äî all while maintaining a deep prayer life. He once said, 'The internet is a gift from God, and we must use it well.'",
      "challenge": {
        "type": "dilemma",
        "prompt": "You have a talent for technology. How do you use it for God?",
        "options": [
          "Teach others what you've learned and share the faith",
          "Keep your skills to yourself",
          "Use it only to gain followers",
          "Abandon technology entirely"
        ],
        "answer_index": 0
      },
      "reward": {
        "Wisdom": 2,
        "Faith": 1
      }
    },
    {
      "title": "Daily Mass",
      "story": "From the time of his First Communion at age 7, Carlo never missed daily Mass. He called the Eucharist 'my highway to heaven.' Even as a teenager surrounded by secular culture in Milan, he prioritized his time before the Blessed Sacrament above everything else.",
      "challenge": {
        "type": "trivia",
        "question": "Carlo called the Eucharist his '_____ to heaven.'",
        "choices": [
          "Highway",
          "Ladder",
          "Bridge",
          "Doorway"
        ],
        "answer_index": 0
      },
      "reward": {
        "Faith": 2,
        "Wisdom": 1
      }
    },
    {
      "title": "A Heart for the Poor",
      "story": "Despite coming from a wealthy Italian family, Carlo lived simply and gave generously. He saved his allowance to buy sleeping bags for homeless people in Milan, and he volunteered at a soup kitchen run by the Capuchin friars. His mother later said she never knew how much he gave away until after his death.",
      "challenge": {
        "type": "dilemma",
        "prompt": "You receive a generous allowance. What do you do with it?",
        "options": [
          "Save some and give the rest to those in need",
          "Spend it all on yourself ‚Äî you earned it",
          "Save every penny for the future",
          "Give it all away and borrow from friends"
        ],
        "answer_index": 0
      },
      "reward": {
        "Mercy": 2,
        "Faith": 1
      }
    },
    {
      "title": "Called Home Young",
      "story": "In October 2006, 15-year-old Carlo was diagnosed with aggressive leukemia. Facing his death with extraordinary faith, he offered his sufferings for the Pope and the Church. He told his mother, 'I offer all the suffering I will have to endure for the Lord, for the Pope, and for the Church.' He died on October 12, 2006, and was beatified in 2020.",
      "challenge": {
        "type": "trivia",
        "question": "At what age did Carlo Acutis die of leukemia?",
        "choices": [
          "15",
          "12",
          "17",
          "20"
        ],
        "answer_index": 0
      },
      "reward": {
        "Faith": 2,
        "Courage": 1
      }
    }
  ],
  "joan": [
    {
      "title": "Voices from Heaven",
      "story": "In the small village of Domr√©my, 13-year-old Jeanne hears voices in her father's garden. Saints Michael, Catherine, and Margaret speak to her with an impossible command: save France from English occupation. She is an illiterate peasant girl ‚Äî yet the voices are unmistakable and persistent.",
      "challenge": {
        "type": "dilemma",
        "prompt": "You hear a divine call to do something far beyond your abilities. What do you do?",
        "options": [
          "Trust the call and take the first step despite your fear",
          "Wait for a sign that you're truly worthy",
          "Tell no one and hope the voices stop",
          "Ask someone more qualified to go instead"
        ],
        "answer_index": 0
      },
      "reward": {
        "Faith": 2,
        "Courage": 1
      }
    },
    {
      "title": "The Siege of Orl√©ans",
      "story": "Joan convinces the Dauphin to give her armor and an army. At 17, she rides into the besieged city of Orl√©ans, rallying demoralized French troops. In just nine days, she breaks the English siege ‚Äî a turning point in the Hundred Years' War that stunned all of Europe.",
      "challenge": {
        "type": "trivia",
        "question": "How long did it take Joan of Arc to lift the Siege of Orl√©ans?",
        "choices": [
          "Nine days",
          "Three months",
          "One year",
          "Three days"
        ],
        "answer_index": 0
      },
      "reward": {
        "Courage": 2,
        "Faith": 1
      }
    },
    {
      "title": "The Coronation at Reims",
      "story": "After liberating Orl√©ans, Joan escorts the Dauphin Charles through enemy territory to the cathedral at Reims, where French kings are traditionally crowned. On July 17, 1429, Charles VII is crowned King of France ‚Äî fulfilling Joan's divine mission and legitimizing his claim to the throne.",
      "challenge": {
        "type": "trivia",
        "question": "In which cathedral was Charles VII crowned, fulfilling Joan's mission?",
        "choices": [
          "Reims Cathedral",
          "Notre-Dame de Paris",
          "Chartres Cathedral",
          "Sainte-Chapelle"
        ],
        "answer_index": 0
      },
      "reward": {
        "Faith": 1,
        "Courage": 2
      }
    },
    {
      "title": "The Trial",
      "story": "Captured by Burgundian forces and sold to the English, Joan faces a rigged ecclesiastical trial in Rouen. Her judges, loyal to England, twist her words and accuse her of heresy and witchcraft. Despite months of interrogation, the uneducated teenager's answers are so brilliant that they confound the learned theologians.",
      "challenge": {
        "type": "dilemma",
        "prompt": "You face an unjust trial where the verdict is predetermined. How do you respond?",
        "options": [
          "Speak the truth boldly, trusting God with the outcome",
          "Recant everything to save your life",
          "Refuse to speak at all",
          "Try to negotiate a secret deal"
        ],
        "answer_index": 0
      },
      "reward": {
        "Courage": 2,
        "Faith": 1
      }
    },
    {
      "title": "The Flames of Rouen",
      "story": "On May 30, 1431, nineteen-year-old Joan is burned at the stake in the marketplace of Rouen. She asks for a cross to be held before her eyes and calls out the name of Jesus with her final breaths. Twenty-five years later, a retrial declares her innocent. She is canonized in 1920.",
      "challenge": {
        "type": "trivia",
        "question": "What was Joan of Arc's age when she was martyred at Rouen?",
        "choices": [
          "19",
          "17",
          "21",
          "25"
        ],
        "answer_index": 0
      },
      "reward": {
        "Courage": 2,
        "Faith": 2
      }
    },
    {
      "title": "The Sword of Fierbois",
      "story": "Joan tells the Dauphin's men to go to the church of Sainte-Catherine-de-Fierbois and dig behind the altar ‚Äî there they will find a sword marked with five crosses. Astonishingly, they find exactly what she described, buried and rusted. No one can explain how an illiterate peasant girl knew it was there. The sword becomes her weapon of choice.",
      "challenge": {
        "type": "trivia",
        "question": "Where did Joan say a buried sword marked with five crosses would be found?",
        "choices": [
          "Behind the altar at Sainte-Catherine-de-Fierbois",
          "In the royal armory at Chinon",
          "Beneath the walls of Orl√©ans",
          "In a cave near Domr√©my"
        ],
        "answer_index": 0
      },
      "reward": {
        "Faith": 2,
        "Courage": 1
      }
    },
    {
      "title": "The Arc of Joan's Life",
      "story": "Joan of Arc's extraordinary life unfolded in a remarkably short span. From peasant girl to military commander to martyr ‚Äî can you place the key events of her life in order?",
      "challenge": {
        "type": "timeline",
        "prompt": "Arrange Joan's life events from earliest to latest.",
        "events": [
          {
            "text": "Hears voices in Domr√©my",
            "year": 1425
          },
          {
            "text": "Meets the Dauphin at Chinon",
            "year": 1429
          },
          {
            "text": "Lifts the Siege of Orl√©ans",
            "year": 1429
          },
          {
            "text": "Coronation of Charles VII at Reims",
            "year": 1429
          },
          {
            "text": "Burned at the stake in Rouen",
            "year": 1431
          }
        ]
      },
      "reward": {
        "Courage": 2,
        "Faith": 1
      }
    }
  ],
  "aquinas": [
    {
      "title": "The Dumb Ox",
      "story": "Young Thomas is so large, quiet, and slow-moving that his classmates at the University of Paris mock him as 'the Dumb Ox.' His teacher, the great Albertus Magnus, sees something the others miss. After Thomas delivers a brilliant disputation, Albert declares: 'You call him the Dumb Ox, but I tell you this ox will bellow so loud his bellowing will fill the world.'",
      "challenge": {
        "type": "trivia",
        "question": "Who was Thomas Aquinas's famous teacher who defended him as 'the Dumb Ox'?",
        "choices": [
          "Albertus Magnus",
          "Peter Lombard",
          "Bonaventure",
          "Anselm of Canterbury"
        ],
        "answer_index": 0
      },
      "reward": {
        "Wisdom": 2,
        "Faith": 1
      }
    },
    {
      "title": "The Summa Theologica",
      "story": "Thomas embarks on the most ambitious intellectual project in Christian history ‚Äî the Summa Theologica. In this masterwork, he systematically addresses nearly every question about God, creation, morality, and salvation. It contains 3,125 articles, each structured with objections, a core argument, and replies. He never finished it.",
      "challenge": {
        "type": "trivia",
        "question": "How many articles does the Summa Theologica contain?",
        "choices": [
          "About 3,125",
          "About 500",
          "About 10,000",
          "About 1,000"
        ],
        "answer_index": 0
      },
      "reward": {
        "Wisdom": 2,
        "Faith": 1
      }
    },
    {
      "title": "The Five Ways",
      "story": "In the Summa, Thomas presents five rational arguments for the existence of God ‚Äî from motion, causation, contingency, degrees of perfection, and design. These 'Five Ways' become the foundation of natural theology, showing that faith and reason are not enemies but partners in the search for truth.",
      "challenge": {
        "type": "trivia",
        "question": "Which of these is NOT one of Aquinas's Five Ways to prove God's existence?",
        "choices": [
          "The argument from Scripture",
          "The argument from motion",
          "The argument from causation",
          "The argument from design"
        ],
        "answer_index": 0
      },
      "reward": {
        "Wisdom": 2,
        "Courage": 1
      }
    },
    {
      "title": "Pange Lingua",
      "story": "Pope Urban IV asks Thomas to compose hymns for the new feast of Corpus Christi. Thomas writes 'Pange Lingua' and 'Tantum Ergo' ‚Äî Eucharistic hymns of such beauty and theological precision that they are still sung in every Catholic church nearly 800 years later.",
      "challenge": {
        "type": "dilemma",
        "prompt": "You're asked to create something to honor the Eucharist. What approach do you take?",
        "options": [
          "Pour your deepest understanding of the mystery into art",
          "Copy what others have done before",
          "Decline ‚Äî you're a thinker, not an artist",
          "Rush through it to move on to 'real' work"
        ],
        "answer_index": 0
      },
      "reward": {
        "Faith": 2,
        "Wisdom": 1
      }
    },
    {
      "title": "Straw and Fire",
      "story": "On December 6, 1273, during Mass, Thomas has a mystical experience so profound that he stops writing forever. When urged to continue the Summa, he replies: 'Everything I have written seems like straw compared to what has now been revealed to me.' The greatest intellect of his age falls silent before the mystery of God.",
      "challenge": {
        "type": "dilemma",
        "prompt": "After a profound spiritual experience, you realize your life's work feels incomplete. What do you do?",
        "options": [
          "Accept that some mysteries are beyond words and rest in God",
          "Force yourself to keep writing ‚Äî the work must be finished",
          "Doubt the experience and return to normal",
          "Tell everyone about your vision to gain fame"
        ],
        "answer_index": 0
      },
      "reward": {
        "Faith": 2,
        "Wisdom": 2
      }
    },
    {
      "title": "The Family Kidnapping",
      "story": "When 19-year-old Thomas announces he wants to join the Dominican friars ‚Äî a mendicant order that begs for its food ‚Äî his noble family is horrified. His brothers kidnap him and lock him in the family castle for over a year, even sending a temptress to his room to break his resolve. Thomas drives her away with a burning log and spends his captivity studying Scripture.",
      "challenge": {
        "type": "trivia",
        "question": "How long did Thomas Aquinas's family hold him captive to prevent him from joining the Dominicans?",
        "choices": [
          "Over a year",
          "One week",
          "Three months",
          "Five years"
        ],
        "answer_index": 0
      },
      "reward": {
        "Courage": 2,
        "Faith": 1
      }
    },
    {
      "title": "The Mind of the Ages",
      "story": "Thomas Aquinas's intellectual journey shaped Western thought for centuries. From reluctant student to the greatest theologian in history ‚Äî place these milestones in order.",
      "challenge": {
        "type": "timeline",
        "prompt": "Arrange these events from Aquinas's life in order.",
        "events": [
          {
            "text": "Called 'the Dumb Ox' at university",
            "year": 1245
          },
          {
            "text": "Family kidnaps him to prevent him joining Dominicans",
            "year": 1244
          },
          {
            "text": "Begins writing the Summa Theologica",
            "year": 1265
          },
          {
            "text": "Composes Pange Lingua hymn",
            "year": 1264
          },
          {
            "text": "Mystical experience ‚Äî stops writing forever",
            "year": 1273
          }
        ]
      },
      "reward": {
        "Wisdom": 2,
        "Faith": 1
      }
    }
  ],
  "teresa": [
    {
      "title": "Agnes of Skopje",
      "story": "Mother Teresa was born Anjez√´ Gonxhe Bojaxhiu on August 26, 1910, in Skopje, in what is now North Macedonia. She was Albanian, not Indian ‚Äî a fact that surprises many. At 18, she left home forever to join the Sisters of Loreto in Ireland, then traveled to India. She never saw her mother or sister again.",
      "challenge": {
        "type": "trivia",
        "question": "In which city was Mother Teresa born?",
        "choices": [
          "Skopje",
          "Calcutta",
          "Tirana",
          "Rome"
        ],
        "answer_index": 0
      },
      "reward": {
        "Courage": 1,
        "Faith": 2
      }
    },
    {
      "title": "The Sari as Habit",
      "story": "When Mother Teresa founded the Missionaries of Charity, she chose a simple white cotton sari with blue borders as the order's habit ‚Äî the dress of the poorest Indian women. It was a radical departure from traditional religious habits and a powerful symbol: the sisters would dress as the poor they served, not above them.",
      "challenge": {
        "type": "dilemma",
        "prompt": "You're founding a new religious order to serve the poorest. What should the members wear?",
        "options": [
          "The clothing of the poor they serve, as a sign of solidarity",
          "Traditional ornate religious vestments",
          "Normal civilian clothing to blend in",
          "Matching uniforms to show organization"
        ],
        "answer_index": 0
      },
      "reward": {
        "Mercy": 2,
        "Wisdom": 1
      }
    },
    {
      "title": "A Princess and a Saint",
      "story": "Mother Teresa and Princess Diana formed an unlikely friendship, meeting several times in the early 1990s. Diana visited Mother Teresa's hospice in Calcutta and was deeply moved. When both died within days of each other in September 1997, the world mourned two women who, in very different ways, brought compassion to global consciousness.",
      "challenge": {
        "type": "trivia",
        "question": "Mother Teresa and Princess Diana died within how many days of each other in 1997?",
        "choices": [
          "About five days",
          "About thirty days",
          "The same day",
          "About six months"
        ],
        "answer_index": 0
      },
      "reward": {
        "Mercy": 1,
        "Faith": 1
      }
    },
    {
      "title": "Canonization",
      "story": "On September 4, 2016, Pope Francis canonized Mother Teresa before 120,000 people in St. Peter's Square. The miracle attributed to her intercession involved a Brazilian man with multiple brain tumors who was inexplicably cured. She became St. Teresa of Calcutta ‚Äî though to most of the world, she had been a saint all along.",
      "challenge": {
        "type": "trivia",
        "question": "Which Pope canonized Mother Teresa in 2016?",
        "choices": [
          "Pope Francis",
          "Pope Benedict XVI",
          "Pope John Paul II",
          "Pope John XXIII"
        ],
        "answer_index": 0
      },
      "reward": {
        "Faith": 2,
        "Mercy": 1
      }
    },
    {
      "title": "Do Small Things with Great Love",
      "story": "Mother Teresa's most enduring teaching is breathtakingly simple: 'Not all of us can do great things. But we can do small things with great love.' She insisted that holiness wasn't about grand gestures but about the love poured into every act ‚Äî holding a dying person's hand, offering a glass of water, smiling at a stranger.",
      "challenge": {
        "type": "dilemma",
        "prompt": "You want to change the world but feel powerless. What is the most powerful thing you can do?",
        "options": [
          "Do small things with great love, starting right where you are",
          "Wait until you have more resources and influence",
          "Focus on one big dramatic project",
          "Give up ‚Äî the problems are too large"
        ],
        "answer_index": 0
      },
      "reward": {
        "Mercy": 2,
        "Wisdom": 1
      }
    },
    {
      "title": "The Call Within a Call",
      "story": "Sister Teresa is already a nun teaching at a comfortable school in Calcutta when, on a train to Darjeeling in 1946, she receives what she calls 'a call within a call' ‚Äî a vision of Jesus asking her to leave the convent and serve the poorest of the poor in the slums. It means giving up everything she knows.",
      "challenge": {
        "type": "dilemma",
        "prompt": "You have a comfortable life serving God, but feel called to something harder. What do you do?",
        "options": [
          "Leave your comfort zone and follow the call",
          "Stay where you are ‚Äî you're already serving God",
          "Ask for more time to think about it",
          "Suggest someone else is better suited"
        ],
        "answer_index": 0
      },
      "reward": {
        "Faith": 2,
        "Mercy": 1
      }
    },
    {
      "title": "Works of Mercy",
      "story": "Many saints devoted their lives to serving others in unique ways. Each found their own path to bring God's love into the world. Can you match these saints to their primary works of mercy?",
      "challenge": {
        "type": "matching",
        "prompt": "Match each saint to their primary work.",
        "pairs": [
          {
            "left": "Mother Teresa",
            "right": "Home for the dying"
          },
          {
            "left": "Pier Giorgio Frassati",
            "right": "Giving away his bus fare"
          },
          {
            "left": "St. Th√©r√®se",
            "right": "The Little Way"
          },
          {
            "left": "St. Francis",
            "right": "Radical poverty"
          },
          {
            "left": "Carlo Acutis",
            "right": "Digital evangelization"
          }
        ]
      },
      "reward": {
        "Mercy": 2,
        "Faith": 1
      }
    }
  ],
  "patrick": [
    {
      "title": "Kidnapped to Ireland",
      "story": "At 16, the Roman-British boy Patricius is kidnapped by Irish raiders and sold into slavery. For six years he tends sheep on a cold Irish hillside, alone and far from home. In his isolation, he turns to prayer ‚Äî praying a hundred times a day and a hundred times each night ‚Äî and discovers a faith he never had as a free boy.",
      "challenge": {
        "type": "trivia",
        "question": "How many years was St. Patrick held as a slave in Ireland?",
        "choices": [
          "Six years",
          "Two years",
          "Ten years",
          "Twelve years"
        ],
        "answer_index": 0
      },
      "reward": {
        "Courage": 2,
        "Faith": 1
      }
    },
    {
      "title": "The Great Escape",
      "story": "After six years of slavery, Patrick hears a voice in a dream telling him his ship is ready. He walks nearly 200 miles to the coast, convinces a crew of strangers to take him aboard, and eventually makes it back to Britain. Most people would never look back ‚Äî but Patrick can't forget the Irish people.",
      "challenge": {
        "type": "dilemma",
        "prompt": "You've escaped captivity and returned home safely. But you dream of the people who enslaved you calling for help. What do you do?",
        "options": [
          "Return to bring them the faith that saved you",
          "Stay safe at home ‚Äî you've suffered enough",
          "Send someone else in your place",
          "Try to forget the dreams"
        ],
        "answer_index": 0
      },
      "reward": {
        "Courage": 2,
        "Mercy": 1
      }
    },
    {
      "title": "The Shamrock",
      "story": "Now a bishop, Patrick returns to Ireland to evangelize the pagan Celts. When the High King's druids challenge him to explain the Christian Trinity ‚Äî how God can be three persons yet one God ‚Äî Patrick bends down and picks a shamrock from the grass. 'Three leaves, one plant,' he says. The image becomes the most famous symbol of Ireland.",
      "challenge": {
        "type": "trivia",
        "question": "What doctrine did St. Patrick explain using the shamrock?",
        "choices": [
          "The Holy Trinity",
          "The Incarnation",
          "The Resurrection",
          "The Immaculate Conception"
        ],
        "answer_index": 0
      },
      "reward": {
        "Wisdom": 1,
        "Faith": 2
      }
    },
    {
      "title": "Driving Out the Serpents",
      "story": "Legend holds that Patrick drove all the snakes from Ireland by standing on a hilltop and commanding them into the sea. While Ireland indeed has no native snakes, scholars believe the story symbolizes Patrick driving out pagan worship ‚Äî the 'serpents' of druidic religion that held the Irish people in spiritual bondage.",
      "challenge": {
        "type": "trivia",
        "question": "What do most scholars believe the 'snakes' St. Patrick drove from Ireland symbolize?",
        "choices": [
          "Pagan/druidic worship",
          "Actual reptiles",
          "Viking invaders",
          "Roman soldiers"
        ],
        "answer_index": 0
      },
      "reward": {
        "Courage": 1,
        "Wisdom": 2
      }
    },
    {
      "title": "The Breastplate",
      "story": "Patrick composes the Lorica ‚Äî 'St. Patrick's Breastplate' ‚Äî a powerful prayer of protection invoking the Trinity, the forces of creation, and the armor of God. 'Christ with me, Christ before me, Christ behind me, Christ in me, Christ beneath me, Christ above me.' It has been prayed by Christians for over 1,500 years.",
      "challenge": {
        "type": "dilemma",
        "prompt": "You face spiritual danger. How do you protect yourself?",
        "options": [
          "Pray for Christ's protection in every direction",
          "Rely on your own strength and intelligence",
          "Avoid the situation entirely",
          "Ask others to pray while you stand aside"
        ],
        "answer_index": 0
      },
      "reward": {
        "Faith": 2,
        "Courage": 1
      }
    }
  ],
  "therese": [
    {
      "title": "The Little Flower",
      "story": "Th√©r√®se Martin grows up in Lisieux, France, the youngest of five sisters ‚Äî four of whom become nuns. She is intensely sensitive, prone to tears, and seemingly unremarkable. Yet beneath her fragile exterior burns an enormous desire: to become a great saint. She will find a way no one expects.",
      "challenge": {
        "type": "dilemma",
        "prompt": "You feel a burning desire to do something great for God, but you seem ordinary. What do you do?",
        "options": [
          "Commit to doing small things with extraordinary love",
          "Wait until you develop extraordinary abilities",
          "Compare yourself to greater saints and feel inadequate",
          "Pursue dramatic, visible acts of holiness"
        ],
        "answer_index": 0
      },
      "reward": {
        "Faith": 2,
        "Mercy": 1
      }
    },
    {
      "title": "Pleading with the Pope",
      "story": "At just 14, Th√©r√®se is desperate to enter the Carmelite convent but is told she's too young. On a family pilgrimage to Rome, she breaks protocol during a papal audience and falls at the feet of Pope Leo XIII, begging permission to enter Carmel at 15. The guards drag her away, but the Pope is impressed by her boldness.",
      "challenge": {
        "type": "trivia",
        "question": "At what age did Th√©r√®se enter the Carmelite convent?",
        "choices": [
          "15",
          "18",
          "12",
          "21"
        ],
        "answer_index": 0
      },
      "reward": {
        "Courage": 2,
        "Faith": 1
      }
    },
    {
      "title": "The Little Way",
      "story": "Inside the convent, Th√©r√®se discovers her path to holiness: 'The Little Way.' She will not perform great penances or dramatic miracles. Instead, she will do every small task ‚Äî washing dishes, enduring a sister's annoying habits, smiling through pain ‚Äî with perfect love. 'Miss no single opportunity of making some small sacrifice,' she writes.",
      "challenge": {
        "type": "trivia",
        "question": "What is St. Th√©r√®se's spiritual path called?",
        "choices": [
          "The Little Way",
          "The Dark Night",
          "The Spiritual Exercises",
          "The Interior Castle"
        ],
        "answer_index": 0
      },
      "reward": {
        "Faith": 1,
        "Mercy": 2
      }
    },
    {
      "title": "Story of a Soul",
      "story": "Under obedience to her superior, Th√©r√®se writes her autobiography ‚Äî 'Story of a Soul.' She describes her childhood, her vocation, and her Little Way with disarming honesty and poetic beauty. Published after her death, it becomes one of the most widely read spiritual books in history, inspiring millions.",
      "challenge": {
        "type": "trivia",
        "question": "What is the title of St. Th√©r√®se's autobiography?",
        "choices": [
          "Story of a Soul",
          "The Interior Castle",
          "Dark Night of the Soul",
          "Confessions"
        ],
        "answer_index": 0
      },
      "reward": {
        "Wisdom": 1,
        "Faith": 2
      }
    },
    {
      "title": "A Shower of Roses",
      "story": "Dying of tuberculosis at 24, Th√©r√®se promises: 'After my death, I will let fall a shower of roses. I will spend my heaven doing good upon earth.' Within years of her death, reports of miracles and answered prayers flood in from around the world. She is declared a Doctor of the Church ‚Äî one of only four women to receive the title.",
      "challenge": {
        "type": "trivia",
        "question": "St. Th√©r√®se is one of how many women declared a Doctor of the Church?",
        "choices": [
          "Four",
          "Two",
          "Seven",
          "One"
        ],
        "answer_index": 0
      },
      "reward": {
        "Faith": 2,
        "Mercy": 2
      }
    }
  ],
  "frassati": [
    {
      "title": "To the Heights!",
      "story": "Pier Giorgio Frassati is the son of the founder of the influential Italian newspaper La Stampa. Rich, handsome, and athletic, he could live a life of pure comfort. Instead, his motto is 'Verso l'alto!' ‚Äî 'To the heights!' ‚Äî referring not just to his beloved mountains but to the spiritual summit he pursues with reckless joy.",
      "challenge": {
        "type": "dilemma",
        "prompt": "You're born into wealth and privilege. What drives your life?",
        "options": [
          "Pursuing both physical and spiritual heights with joy",
          "Enjoying comfort ‚Äî you've earned it by birth",
          "Rejecting your family entirely to prove your virtue",
          "Using your status to gain political power"
        ],
        "answer_index": 0
      },
      "reward": {
        "Courage": 2,
        "Faith": 1
      }
    },
    {
      "title": "The Secret Charity",
      "story": "Pier Giorgio gives away nearly everything ‚Äî his money, his clothes, even his bus fare (walking home in the rain so a poor family can eat). He keeps his charity so secret that his wealthy family has no idea. They think he's irresponsible with money. Only after his death do hundreds of poor families come forward to mourn the young man who helped them.",
      "challenge": {
        "type": "trivia",
        "question": "How did Pier Giorgio's family learn about his extensive charity work?",
        "choices": [
          "Poor families came forward after his death",
          "He told them on his deathbed",
          "A priest revealed it",
          "They found his journal"
        ],
        "answer_index": 0
      },
      "reward": {
        "Mercy": 2,
        "Courage": 1
      }
    },
    {
      "title": "The Mountain Climber",
      "story": "Pier Giorgio is a passionate mountaineer, organizing trips with his friends to the Italian Alps. For him, climbing is both physical exhilaration and spiritual practice ‚Äî each summit brings him closer to God. His hiking group calls themselves 'I Tipi Loschi' ‚Äî 'The Shady Characters' ‚Äî and they combine adventure with deep friendship and faith.",
      "challenge": {
        "type": "dilemma",
        "prompt": "How do you combine friendship, adventure, and faith?",
        "options": [
          "Build a community around shared joy and spiritual growth",
          "Keep faith and fun strictly separate",
          "Only befriend people who share your beliefs",
          "Sacrifice all recreation for prayer and service"
        ],
        "answer_index": 0
      },
      "reward": {
        "Courage": 1,
        "Faith": 1,
        "Mercy": 1
      }
    },
    {
      "title": "Standing Against Fascism",
      "story": "In 1920s Italy, Mussolini's Fascists are rising to power. Despite his father's connections to the political establishment, Pier Giorgio actively opposes Fascism, joining Catholic Action and speaking out for workers' rights. He is beaten by Blackshirts at a protest but refuses to back down ‚Äî combining his faith with fearless political courage.",
      "challenge": {
        "type": "trivia",
        "question": "What political movement did Pier Giorgio Frassati actively oppose?",
        "choices": [
          "Italian Fascism",
          "Communism",
          "Anarchism",
          "Monarchism"
        ],
        "answer_index": 0
      },
      "reward": {
        "Courage": 2,
        "Wisdom": 1
      }
    },
    {
      "title": "A Death That Shook Turin",
      "story": "At just 24, Pier Giorgio contracts polio ‚Äî likely from the sick he served in Turin's poorest neighborhoods. He dies on July 4, 1925. His aristocratic family expects a small funeral. Instead, thousands of poor people flood the streets of Turin, weeping for the young man who gave them everything. His family is stunned ‚Äî they had no idea.",
      "challenge": {
        "type": "trivia",
        "question": "What disease took Pier Giorgio Frassati's life at age 24?",
        "choices": [
          "Polio",
          "Tuberculosis",
          "Influenza",
          "Typhoid"
        ],
        "answer_index": 0
      },
      "reward": {
        "Mercy": 2,
        "Faith": 1
      }
    },
    {
      "title": "The Rosary in His Hands",
      "story": "When Pier Giorgio lay dying, his family found a Rosary clutched in his paralyzed hands ‚Äî he could barely move but refused to let go of it. At his funeral, a small note was discovered in his pocket with instructions to deliver medicine to a sick man he had been visiting. Even on his deathbed, he was thinking of others.",
      "challenge": {
        "type": "dilemma",
        "prompt": "You are gravely ill but know someone who needs help. What do you do?",
        "options": [
          "Make sure someone carries out the errand of mercy on your behalf",
          "Focus entirely on your own recovery",
          "Feel guilty but accept you can't help right now",
          "Wait until you recover to help them"
        ],
        "answer_index": 0
      },
      "reward": {
        "Mercy": 2,
        "Courage": 1
      }
    }
  ]
};
    // Merge extra quests into main quests object
    for (const [saint, extra] of Object.entries(extraQuests)) {
      if (quests[saint]) quests[saint].push(...extra);
    }

    // Saint quotes for intro screen
    const saintQuotes = {
      francis: "Start by doing what's necessary; then do what's possible; and suddenly you are doing the impossible.",
      carlo: "Everyone is born as an original, but many people end up dying as photocopies.",
      joan: "I am not afraid; I was born to do this.",
      aquinas: "The things that we love tell us what we are.",
      teresa: "Not all of us can do great things. But we can do small things with great love.",
      patrick: "Christ with me, Christ before me, Christ behind me, Christ in me.",
      therese: "Miss no single opportunity of making some small sacrifice.",
      frassati: "To live without faith, without a patrimony to defend, without a steady struggle for truth ‚Äî that is not living but existing.",
      joan: "I am not afraid; I was born to do this.",
      aquinas: "The things that we love tell us what we are.",
      teresa: "Not all of us can do great things. But we can do small things with great love.",
      frassati: "To live without faith, without a patrimony to defend, without a steady struggle for truth ‚Äî that is not living but existing."
    };

    // Achievement definitions
    const achievementDefs = [
      { id: 'first_steps', name: 'First Steps', desc: 'Complete any saint\'s journey', icon: 'üë£',
        check: (d) => d.justCompleted },
      { id: 'perfect_saint', name: 'Perfect Saint', desc: 'Get every question right for one saint', icon: 'üòá',
        check: (d) => d.totalCorrect === d.totalQuestions && d.totalQuestions > 0 },
      { id: 'scholar', name: 'Scholar', desc: 'Complete 3 different saints', icon: 'üéì',
        check: (d) => Object.keys(d.completedSaints).length >= 3 },
      { id: 'master_scholar', name: 'Master Scholar', desc: 'Complete all 8 saints', icon: 'üèÜ',
        check: (d) => Object.keys(d.completedSaints).length >= 8 },
      { id: 'speed_demon', name: 'Speed Demon', desc: 'Complete a saint on Hard mode', icon: '‚ö°',
        check: (d) => d.completedOnHard },
      { id: 'virtue_master', name: 'Virtue Master', desc: 'Reach 10+ in a single virtue', icon: 'üí™',
        check: (d) => Object.values(d.endVirtues).some(v => v >= 10) },
      { id: 'streak_king', name: 'Streak King', desc: 'Get a 5+ answer streak', icon: 'üî•',
        check: (d) => d.maxStreak >= 5 },
      { id: 'well_rounded', name: 'Well Rounded', desc: 'Have all 4 virtues above 5', icon: 'üéØ',
        check: (d) => Object.values(d.endVirtues).every(v => v >= 5) }
    ];

    // Security: HTML escape helper
    function escapeHTML(str) {
      const div = document.createElement('div');
      div.appendChild(document.createTextNode(str));
      return div.innerHTML;
    }

    // Security: Safe localStorage read
    function safeGetJSON(key, fallback) {
      try {
        return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback));
      } catch (e) {
        return fallback;
      }
    }

    // Seeded PRNG for daily challenge (mulberry32)
    function seededRandom(seed) {
      let t = seed + 0x6D2B79F5;
      return function() {
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }

    function seededShuffle(arr, rng) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function dateSeed() {
      const d = new Date();
      return d.getFullYear() * 10000 + (d.getMonth() + 1) * 100 + d.getDate();
    }

    // Game State
    let currentSaint = null;
    let currentCheckpoint = 0;
    let virtues = {"Faith": 0, "Mercy": 0, "Courage": 0, "Wisdom": 0};
    let gameScreen = "select";
    let difficulty = "easy";
    let timerInterval = null;
    let timeLeft = 15;

    let currentQuests = [];
    let inBonusRound = false;
    let bonusQuestions = [];
    let bonusIndex = 0;

    // New state: streaks, tracking, daily challenge
    let currentStreak = 0;
    let maxStreak = 0;
    let totalCorrect = 0;
    let totalQuestions = 0;
    let bonusCorrect = 0;
    let answerHistory = [];
    let isDailyChallenge = false;

    function shuffleArray(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function setDifficulty(d, btn) {
      difficulty = d;
      document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      playSound('click');
    }

    function startTimer() {
      if (difficulty !== 'hard') return;
      const timerBar = document.getElementById('timer-bar');
      const timerFill = document.getElementById('timer-fill');
      timerBar.style.display = 'block';
      timeLeft = 15;
      timerFill.style.width = '100%';
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeLeft -= 0.1;
        timerFill.style.width = Math.max(0, (timeLeft / 15) * 100) + '%';
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          autoSubmitWrong();
        }
      }, 100);
    }

    function stopTimer() {
      clearInterval(timerInterval);
      document.getElementById('timer-bar').style.display = 'none';
    }

    function autoSubmitWrong() {
      if (isAnswerSubmitted) return;
      isAnswerSubmitted = true;
      stopTimer();
      playSound('wrong');
      shakeScreen();

      // Track the timeout as a wrong answer
      const q = currentQuests[currentCheckpoint];
      if (q) {
        const ch = q.challenge;
        totalQuestions++;
        currentStreak = 0;
        answerHistory.push({
          title: q.title,
          question: ch.type === 'trivia' ? ch.question : ch.prompt,
          choices: ch.type === 'trivia' ? ch.choices : ch.options,
          selectedIndex: -1,
          correctIndex: ch.answer_index,
          wasCorrect: false,
          isBonus: inBonusRound
        });
        updateStreakDisplay();
      }

      const resultEl = document.createElement('div');
      resultEl.className = 'result incorrect';
      resultEl.textContent = "‚è∞ Time's up!";
      questionContainer.appendChild(resultEl);
      setTimeout(() => {
        currentCheckpoint++;
        if (currentCheckpoint >= currentQuests.length) { if (!inBonusRound) startBonusRound(); else endGame(); } else { loadQuest(); }
        isAnswerSubmitted = false;
      }, 2000);
    }

    function showHint(q) {
      if (difficulty !== 'easy') return;
      const hintEl = document.getElementById('hint-text');
      const ch = q.challenge;
      if (ch.type === 'trivia') {
        const correct = ch.choices[ch.answer_index];
        hintEl.textContent = 'üí° Hint: The answer starts with "' + correct.charAt(0) + '"';
      } else {
        hintEl.textContent = 'üí° Hint: Think about what this saint would actually do.';
      }
      hintEl.style.display = 'block';
    }

    function spawnParticles(emoji) {
      for (let i = 0; i < 12; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.textContent = emoji;
        p.style.left = (Math.random() * 60 + 20) + 'vw';
        p.style.top = (Math.random() * 40 + 30) + 'vh';
        p.style.fontSize = (Math.random() * 16 + 12) + 'px';
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 1000);
      }
    }

    function shakeScreen() {
      const container = document.querySelector('.container');
      container.classList.add('shake');
      setTimeout(() => container.classList.remove('shake'), 400);
    }

    // Sound effects ‚Äî lazy AudioContext (Security Fix: avoid eager creation)
    let audioContext = null;
    function getAudioContext() {
      if (!audioContext) {
        try {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) { return null; }
      }
      if (audioContext.state === 'suspended') audioContext.resume();
      return audioContext;
    }

    function playSound(type) {
      const ctx = getAudioContext();
      if (!ctx) return;

      const oscillator = ctx.createOscillator();
      const gainNode = ctx.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(ctx.destination);

      if (type === 'click') {
        oscillator.type = 'sine';
        oscillator.frequency.value = 440;
        gainNode.gain.value = 0.3;
      } else if (type === 'correct') {
        oscillator.type = 'sine';
        oscillator.frequency.value = 880;
        gainNode.gain.value = 0.4;
      } else if (type === 'wrong') {
        oscillator.type = 'sine';
        oscillator.frequency.value = 220;
        gainNode.gain.value = 0.3;
      }

      oscillator.start();
      oscillator.stop(ctx.currentTime + 0.2);

      if (type === 'fanfare') {
        [523, 659, 784].forEach((freq, i) => {
          const osc = ctx.createOscillator();
          const gn = ctx.createGain();
          osc.connect(gn); gn.connect(ctx.destination);
          osc.type = 'sine'; osc.frequency.value = freq;
          gn.gain.value = 0.25;
          osc.start(ctx.currentTime + i * 0.15);
          osc.stop(ctx.currentTime + i * 0.15 + 0.4);
        });
      }
    }


    // === Matching Challenge Logic ===
    let matchSelectedLeft = null;
    let matchPairs = [];
    let matchCorrect = 0;
    let matchTotal = 0;
    let matchShuffledRight = [];

    function renderMatchingChallenge(ch) {
      matchPairs = ch.pairs;
      matchCorrect = 0;
      matchTotal = ch.pairs.length;
      matchSelectedLeft = null;
      matchShuffledRight = [...ch.pairs.map(p => p.right)];
      for (let i = matchShuffledRight.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [matchShuffledRight[i], matchShuffledRight[j]] = [matchShuffledRight[j], matchShuffledRight[i]];
      }

      questionContainer.innerHTML = '<h3>üîó Match the Pairs</h3>' +
        '<p>' + escapeHTML(ch.prompt || 'Match each item on the left with its correct pair on the right.') + '</p>' +
        '<div class="match-grid">' +
          '<div class="match-column" id="match-left">' +
            ch.pairs.map((p, i) => '<div class="match-item" data-side="left" data-idx="' + i + '" onclick="matchClick(this)">' + escapeHTML(p.left) + '</div>').join('') +
          '</div>' +
          '<div class="match-column" id="match-right">' +
            matchShuffledRight.map((r, i) => '<div class="match-item" data-side="right" data-idx="' + i + '" onclick="matchClick(this)">' + escapeHTML(r) + '</div>').join('') +
          '</div>' +
        '</div>' +
        '<div id="match-status" style="text-align:center;margin-top:10px;"></div>';
    }

    function matchClick(el) {
      if (el.classList.contains('matched')) return;
      const side = el.dataset.side;
      const idx = parseInt(el.dataset.idx);

      if (side === 'left') {
        document.querySelectorAll('#match-left .match-item').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
        matchSelectedLeft = idx;
      } else if (side === 'right' && matchSelectedLeft !== null) {
        const leftIdx = matchSelectedLeft;
        const rightText = matchShuffledRight[idx];
        const correctRight = matchPairs[leftIdx].right;

        const leftEl = document.querySelector('#match-left .match-item[data-idx="' + leftIdx + '"]');

        if (rightText === correctRight) {
          leftEl.classList.remove('selected');
          leftEl.classList.add('matched');
          el.classList.add('matched');
          matchCorrect++;
          playSound('correct');

          if (matchCorrect === matchTotal) {
            setTimeout(() => finishMatchingChallenge(true), 500);
          }
        } else {
          el.classList.add('wrong-flash');
          playSound('wrong');
          shakeScreen();
          setTimeout(() => el.classList.remove('wrong-flash'), 500);
        }
        matchSelectedLeft = null;
        document.querySelectorAll('#match-left .match-item').forEach(e => e.classList.remove('selected'));
      }
    }

    function finishMatchingChallenge(allCorrect) {
      const q = currentQuests[currentCheckpoint];
      totalQuestions++;
      if (allCorrect) {
        totalCorrect++;
        currentStreak++;
        if (currentStreak > maxStreak) maxStreak = currentStreak;
        for (const [key, value] of Object.entries(q.reward)) { virtues[key] += value; }
        spawnParticles('‚ú®');
        const resultEl = document.createElement('div');
        resultEl.className = 'result correct';
        resultEl.textContent = 'All matched correctly! +Virtue';
        questionContainer.appendChild(resultEl);
      }
      answerHistory.push({ title: q.title, question: 'Matching Challenge', choices: [], selectedIndex: 0, correctIndex: 0, wasCorrect: allCorrect, isBonus: false });
      updateStreakDisplay();
      updateProfile();
      setTimeout(() => {
        currentCheckpoint++;
        if (currentCheckpoint >= currentQuests.length) { if (!inBonusRound) startBonusRound(); else endGame(); } else { loadQuest(); }
        isAnswerSubmitted = false;
      }, 2000);
    }

    // === Timeline Challenge Logic ===
    let timelineEvents = [];
    let timelinePlacements = [];
    let timelineNextSlot = 0;

    function renderTimelineChallenge(ch) {
      timelineEvents = [...ch.events];
      timelinePlacements = [];
      timelineNextSlot = 0;
      const shuffled = [...ch.events];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }

      questionContainer.innerHTML = '<h3>üìÖ Timeline Challenge</h3>' +
        '<p>' + escapeHTML(ch.prompt || 'Place these events in chronological order, earliest first.') + '</p>' +
        '<div class="timeline-events">' +
          ch.events.map((_, i) => '<div class="timeline-slot" id="tslot-' + i + '"><span class="slot-num">' + (i + 1) + '.</span><span class="slot-text">‚Äî</span></div>').join('') +
        '</div>' +
        '<div class="timeline-pool" id="timeline-pool">' +
          shuffled.map((e, i) => '<button class="timeline-event-btn" data-year="' + e.year + '" data-text="' + escapeHTML(e.text) + '" onclick="placeTimelineEvent(this)">' + escapeHTML(e.text) + ' (' + e.year + ')</button>').join('') +
        '</div>';
    }

    function placeTimelineEvent(btn) {
      if (timelineNextSlot >= timelineEvents.length) return;
      const slot = document.getElementById('tslot-' + timelineNextSlot);
      slot.querySelector('.slot-text').textContent = btn.dataset.text + ' (' + btn.dataset.year + ')';
      slot.classList.add('filled');
      slot.dataset.year = btn.dataset.year;
      btn.classList.add('placed');
      timelinePlacements.push(parseInt(btn.dataset.year));
      timelineNextSlot++;

      if (timelineNextSlot >= timelineEvents.length) {
        setTimeout(() => checkTimelineResult(), 300);
      }
    }

    function checkTimelineResult() {
      const sorted = [...timelineEvents].sort((a, b) => a.year - b.year);
      let correct = 0;
      for (let i = 0; i < sorted.length; i++) {
        const slot = document.getElementById('tslot-' + i);
        if (timelinePlacements[i] === sorted[i].year) {
          slot.classList.add('timeline-result-correct');
          correct++;
        } else {
          slot.classList.add('timeline-result-wrong');
        }
      }

      const allCorrect = correct === sorted.length;
      const q = currentQuests[currentCheckpoint];
      totalQuestions++;
      if (allCorrect) {
        totalCorrect++;
        currentStreak++;
        if (currentStreak > maxStreak) maxStreak = currentStreak;
        for (const [key, value] of Object.entries(q.reward)) { virtues[key] += value; }
        playSound('correct');
        spawnParticles('‚ú®');
        const resultEl = document.createElement('div');
        resultEl.className = 'result correct';
        resultEl.textContent = 'Perfect timeline! +Virtue';
        questionContainer.appendChild(resultEl);
      } else {
        currentStreak = 0;
        playSound('wrong');
        shakeScreen();
        const resultEl = document.createElement('div');
        resultEl.className = 'result incorrect';
        resultEl.textContent = correct + '/' + sorted.length + ' in correct position.';
        questionContainer.appendChild(resultEl);
      }

      answerHistory.push({ title: q.title, question: 'Timeline Challenge', choices: [], selectedIndex: correct, correctIndex: sorted.length, wasCorrect: allCorrect, isBonus: false });
      updateStreakDisplay();
      updateProfile();
      setTimeout(() => {
        currentCheckpoint++;
        if (currentCheckpoint >= currentQuests.length) { if (!inBonusRound) startBonusRound(); else endGame(); } else { loadQuest(); }
        isAnswerSubmitted = false;
      }, 2500);
    }

    // === Save/Resume Progress ===
    function saveProgress() {
      if (!currentSaint) return;
      try {
        localStorage.setItem('saintquest_resume', JSON.stringify({
          saint: currentSaint,
          checkpoint: currentCheckpoint,
          virtues: virtues,
          difficulty: difficulty,
          streak: currentStreak,
          maxStreak: maxStreak,
          totalCorrect: totalCorrect,
          totalQuestions: totalQuestions,
          ts: Date.now()
        }));
      } catch(e) {}
    }

    function loadSavedProgress() {
      try {
        const saved = JSON.parse(localStorage.getItem('saintquest_resume'));
        if (saved && saved.saint && Date.now() - saved.ts < 86400000) return saved;
      } catch(e) {}
      return null;
    }

    function clearSavedProgress() {
      localStorage.removeItem('saintquest_resume');
    }

    function showResumePrompt() {
      const saved = loadSavedProgress();
      if (!saved) return;
      const saint = saints.find(s => s.id === saved.saint);
      if (!saint) return;
      const resumeDiv = document.createElement('div');
      resumeDiv.id = 'resume-prompt';
      resumeDiv.style.cssText = 'text-align:center;background:rgba(212,175,55,0.15);border:1px solid var(--accent-gold);border-radius:12px;padding:15px;margin-bottom:15px;';
      resumeDiv.innerHTML = '<p>üìñ Continue your journey with <b>' + escapeHTML(saint.name) + '</b>?</p>' +
        '<p style="font-size:0.9em;opacity:0.7;">Chapter ' + (saved.checkpoint + 1) + ' | ' + Object.values(saved.virtues).reduce((a,b)=>a+b,0) + ' virtue points</p>' +
        '<button class="btn" onclick="resumeGame()" style="margin-right:10px;">Continue</button>' +
        '<button class="btn btn-secondary" onclick="dismissResume()">New Game</button>';
      const grid = document.getElementById('saint-grid');
      grid.parentElement.insertBefore(resumeDiv, grid);
    }

    function resumeGame() {
      const saved = loadSavedProgress();
      if (!saved) return;
      currentSaint = saved.saint;
      currentCheckpoint = saved.checkpoint;
      virtues = saved.virtues;
      difficulty = saved.difficulty || 'easy';
      currentStreak = saved.streak || 0;
      maxStreak = saved.maxStreak || 0;
      totalCorrect = saved.totalCorrect || 0;
      totalQuestions = saved.totalQuestions || 0;
      currentQuests = quests[currentSaint]; // reload quests
      inBonusRound = false;
      isDailyChallenge = false;
      answerHistory = [];
      gameScreen = "play";
      updateScreen();
      updateProfile();
      loadQuest();
      const el = document.getElementById('resume-prompt');
      if (el) el.remove();
    }

    function dismissResume() {
      clearSavedProgress();
      const el = document.getElementById('resume-prompt');
      if (el) el.remove();
    }

    // DOM Elements
    const selectScreen = document.getElementById('select-screen');
    const playScreen = document.getElementById('play-screen');
    const doneScreen = document.getElementById('done-screen');
    const questTitle = document.getElementById('quest-title');
    const questStory = document.getElementById('quest-story');
    const questionContainer = document.getElementById('question-container');
    const profileContent = document.getElementById('profile-content');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const continueBtn = document.getElementById('continue-btn');
    const finalProfile = document.getElementById('final-profile');
    const saintName = document.getElementById('saint-name');
    const balloonsEl = document.getElementById('balloons');

    function selectSaint(saintId) {
      if (!quests[saintId]) return; // Security: validate saintId
      playSound('click');
      currentSaint = saintId;
      currentCheckpoint = 0;
      inBonusRound = false;
      bonusIndex = 0;
      isDailyChallenge = false;
      virtues = {"Faith": 0, "Mercy": 0, "Courage": 0, "Wisdom": 0};
      currentQuests = shuffleArray(quests[saintId]);
      currentStreak = 0;
      maxStreak = 0;
      totalCorrect = 0;
      totalQuestions = 0;
      bonusCorrect = 0;
      answerHistory = [];

      // Show intro screen
      const saint = saints.find(s => s.id === saintId);
      document.getElementById('intro-avatar').textContent = saint.avatar;
      document.getElementById('intro-name').textContent = saint.name;
      document.getElementById('intro-quote').textContent = '"' + (saintQuotes[saintId] || '') + '"';
      const introVirtues = document.getElementById('intro-virtues');
      introVirtues.innerHTML = '';
      saint.virtues.forEach(v => {
        const span = document.createElement('span');
        span.className = 'virtue-badge v-' + v.toLowerCase();
        span.textContent = v;
        introVirtues.appendChild(span);
      });
      gameScreen = "intro";
      updateScreen();
    }

    function beginJourney() {
      playSound('click');
      gameScreen = "play";
      updateScreen();
      updateProfile();
      loadQuest();
    }

    function resetGame() {
      playSound('click');
      currentSaint = null;
      currentCheckpoint = 0;
      inBonusRound = false;
      isDailyChallenge = false;
      virtues = {"Faith": 0, "Mercy": 0, "Courage": 0, "Wisdom": 0};
      currentStreak = 0;
      maxStreak = 0;
      totalCorrect = 0;
      totalQuestions = 0;
      bonusCorrect = 0;
      answerHistory = [];
      gameScreen = "select";
      rebuildSaintGrid();
      buildAchievementsDisplay();
      updateDailyStatus();
      updateScreen();
    }

    function loadQuest() {
      const questList = currentQuests;
      if (!questList || currentCheckpoint >= questList.length) {
        if (!inBonusRound) startBonusRound(); else endGame();
        return;
      }

      const q = questList[currentCheckpoint];

      questTitle.textContent = q.title;
      saveProgress();
      questStory.textContent = q.story;

      // Generate question elements
      questionContainer.innerHTML = '';


      // New challenge types
      if (q.challenge.type === 'matching') {
        renderMatchingChallenge(q.challenge);
        document.getElementById('hint-text').style.display = 'none';
        return; // matching has its own submission flow
      } else if (q.challenge.type === 'timeline') {
        renderTimelineChallenge(q.challenge);
        document.getElementById('hint-text').style.display = 'none';
        return; // timeline has its own submission flow
      }

      if (q.challenge.type === 'trivia') {
        questionContainer.innerHTML = `
          <h3>üìú Knowledge Check</h3>
          <p>${escapeHTML(q.challenge.question)}</p>
          <div class="radio-group">
            ${q.challenge.choices.map((choice, index) => `
              <label class="radio-option">
                <input type="radio" name="answer" value="${index}" onclick="submitAnswer(${index}, true)"> ${escapeHTML(choice)}
              </label>
            `).join('')}
          </div>
        `;
      } else if (q.challenge.type === 'dilemma') {
        questionContainer.innerHTML = `
          <h3>‚öñÔ∏è What will you do?</h3>
          <p>${escapeHTML(q.challenge.prompt)}</p>
          <div class="radio-group">
            ${q.challenge.options.map((option, index) => `
              <label class="radio-option">
                <input type="radio" name="answer" value="${index}" onclick="submitAnswer(${index}, false)"> ${escapeHTML(option)}
              </label>
            `).join('')}
          </div>
        `;
      }

      // Difficulty features
      document.getElementById('hint-text').style.display = 'none';
      showHint(q);
      startTimer();
    }

    let isAnswerSubmitted = false;

    function submitAnswer(selectedIndex, isTrivia) {
      if (isAnswerSubmitted) return;
      isAnswerSubmitted = true;

      const questList = currentQuests;
      const q = questList[currentCheckpoint];
      const answer = q.challenge.answer_index;

      if (selectedIndex === -1) {
        isAnswerSubmitted = false;
        return;
      }

      const isCorrect = selectedIndex === answer;
      const ch = q.challenge;
      const choices = ch.type === 'trivia' ? ch.choices : ch.options;

      // Track answer history
      totalQuestions++;
      answerHistory.push({
        title: q.title,
        question: ch.type === 'trivia' ? ch.question : ch.prompt,
        choices: choices,
        selectedIndex: selectedIndex,
        correctIndex: answer,
        wasCorrect: isCorrect,
        isBonus: false
      });

      stopTimer();
      if (isCorrect) {
        currentStreak++;
        totalCorrect++;
        if (currentStreak > maxStreak) maxStreak = currentStreak;

        playSound('correct');
        spawnParticles('‚ú®');
        const resultEl = document.createElement('div');
        resultEl.className = 'result correct';

        // Award base virtues
        for (const [key, value] of Object.entries(q.reward)) {
          virtues[key] += value;
        }

        // Streak bonus
        if (currentStreak >= 5) {
          for (const key of Object.keys(virtues)) { virtues[key] += 1; }
          resultEl.textContent = 'Correct! +Virtue | üî• ' + currentStreak + ' streak! +1 ALL virtues!';
        } else if (currentStreak >= 3) {
          const virtueKeys = Object.keys(virtues);
          const bonusKey = virtueKeys[Math.floor(Math.random() * virtueKeys.length)];
          virtues[bonusKey] += 1;
          resultEl.textContent = 'Correct! +Virtue | üî• ' + currentStreak + ' streak! +1 ' + bonusKey + '!';
        } else {
          resultEl.textContent = 'Correct! +Virtue';
        }
        questionContainer.appendChild(resultEl);
      } else {
        currentStreak = 0;
        playSound('wrong');
        shakeScreen();
        const resultEl = document.createElement('div');
        resultEl.className = 'result incorrect';
        const correctAnswer = choices[answer];
        if (difficulty === 'easy') {
          resultEl.textContent = 'Not quite ‚Äî the answer was: ' + correctAnswer;
        } else {
          resultEl.textContent = 'Not quite ‚Äî try next challenge.';
        }
        questionContainer.appendChild(resultEl);
      }

      updateStreakDisplay();
      updateProfile();

      setTimeout(() => {
        currentCheckpoint++;
        if (currentCheckpoint >= questList.length) {
          if (!inBonusRound) startBonusRound(); else endGame();
        } else {
          loadQuest();
        }
        isAnswerSubmitted = false;
      }, 2000);
    }

    function updateStreakDisplay() {
      const el = document.getElementById('streak-display');
      if (currentStreak >= 5) {
        const flames = 'üî•'.repeat(Math.min(currentStreak - 2, 5));
        el.textContent = flames + ' ' + currentStreak + ' Streak! ' + flames;
        el.classList.add('streak-fire');
        setTimeout(() => el.classList.remove('streak-fire'), 500);
        spawnParticles('‚≠ê');
      } else if (currentStreak >= 3) {
        el.textContent = 'üî• ' + currentStreak + ' Streak!';
        el.classList.add('streak-fire');
        setTimeout(() => el.classList.remove('streak-fire'), 500);
      } else if (currentStreak > 0) {
        el.textContent = '‚úÖ ' + currentStreak + ' in a row';
      } else {
        el.textContent = '';
      }
    }

    function drawRadarChart() {
      const canvas = document.getElementById('radar-canvas');
      const ctx = canvas.getContext('2d');
      const cx = 150, cy = 150, r = 110;
      const labels = ['Faith', 'Mercy', 'Courage', 'Wisdom'];
      const maxVal = Math.max(...Object.values(virtues), 10);
      const values = labels.map(l => (virtues[l] || 0) / maxVal);
      const n = labels.length;

      ctx.clearRect(0, 0, 300, 300);

      // Draw grid rings
      for (let ring = 0.25; ring <= 1; ring += 0.25) {
        ctx.beginPath();
        for (let i = 0; i <= n; i++) {
          const angle = (Math.PI * 2 * (i % n)) / n - Math.PI / 2;
          const x = cx + r * ring * Math.cos(angle);
          const y = cy + r * ring * Math.sin(angle);
          i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
        }
        ctx.strokeStyle = 'rgba(255,255,255,0.1)';
        ctx.stroke();
      }

      // Draw axes
      for (let i = 0; i < n; i++) {
        const angle = (Math.PI * 2 * i) / n - Math.PI / 2;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(cx + r * Math.cos(angle), cy + r * Math.sin(angle));
        ctx.strokeStyle = 'rgba(255,255,255,0.15)';
        ctx.stroke();
      }

      // Draw "perfect" outline
      ctx.beginPath();
      for (let i = 0; i <= n; i++) {
        const angle = (Math.PI * 2 * (i % n)) / n - Math.PI / 2;
        const x = cx + r * Math.cos(angle);
        const y = cy + r * Math.sin(angle);
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      }
      ctx.strokeStyle = 'rgba(212,175,55,0.3)';
      ctx.lineWidth = 2;
      ctx.setLineDash([5, 5]);
      ctx.stroke();
      ctx.setLineDash([]);

      // Draw player values
      ctx.beginPath();
      for (let i = 0; i <= n; i++) {
        const angle = (Math.PI * 2 * (i % n)) / n - Math.PI / 2;
        const v = values[i % n];
        const x = cx + r * v * Math.cos(angle);
        const y = cy + r * v * Math.sin(angle);
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      }
      ctx.fillStyle = 'rgba(99,102,241,0.3)';
      ctx.fill();
      ctx.strokeStyle = '#6366f1';
      ctx.lineWidth = 2;
      ctx.stroke();

      // Draw dots and labels
      const colors = { Faith: '#2196F3', Mercy: '#4CAF50', Courage: '#F44336', Wisdom: '#9C27B0' };
      for (let i = 0; i < n; i++) {
        const angle = (Math.PI * 2 * i) / n - Math.PI / 2;
        const v = values[i];
        const x = cx + r * v * Math.cos(angle);
        const y = cy + r * v * Math.sin(angle);
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, Math.PI * 2);
        ctx.fillStyle = colors[labels[i]];
        ctx.fill();

        // Labels
        const lx = cx + (r + 20) * Math.cos(angle);
        const ly = cy + (r + 20) * Math.sin(angle);
        ctx.fillStyle = colors[labels[i]];
        ctx.font = 'bold 13px Lato, sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(labels[i] + ' ' + (virtues[labels[i]] || 0), lx, ly);
      }
    }

    function startBonusRound() {
      inBonusRound = true;
      bonusIndex = 0;
      // Gather trivia from OTHER saints
      const otherQuests = [];
      for (const [saint, qs] of Object.entries(quests)) {
        if (saint !== currentSaint) {
          qs.filter(q => q.challenge.type === 'trivia').forEach(q => otherQuests.push(q));
        }
      }
      bonusQuestions = shuffleArray(otherQuests).slice(0, 3);
      loadBonusQuest();
    }

    function loadBonusQuest() {
      if (bonusIndex >= bonusQuestions.length) {
        inBonusRound = false;
        endGame();
        return;
      }
      const q = bonusQuestions[bonusIndex];
      questTitle.textContent = '‚≠ê Bonus Round ‚Äî Test Your Knowledge!';
      questStory.textContent = q.story;
      questionContainer.innerHTML = `
        <h3>üìú Bonus Question ${bonusIndex + 1} of 3</h3>
        <p>${escapeHTML(q.challenge.question)}</p>
        <div class="radio-group">
          ${q.challenge.choices.map((choice, index) => `
            <label class="radio-option">
              <input type="radio" name="answer" value="${index}" onclick="submitBonusAnswer(${index})"> ${escapeHTML(choice)}
            </label>
          `).join('')}
        </div>
      `;
      document.getElementById('hint-text').style.display = 'none';
      if (difficulty === 'easy') {
        const hintEl = document.getElementById('hint-text');
        const correct = q.challenge.choices[q.challenge.answer_index];
        hintEl.textContent = 'üí° Hint: The answer starts with "' + correct.charAt(0) + '"';
        hintEl.style.display = 'block';
      }
      startTimer();
      progressText.textContent = `Bonus ${bonusIndex + 1} of 3`;
    }

    function submitBonusAnswer(selectedIndex) {
      if (isAnswerSubmitted) return;
      isAnswerSubmitted = true;
      stopTimer();
      const q = bonusQuestions[bonusIndex];
      const isCorrect = selectedIndex === q.challenge.answer_index;

      totalQuestions++;
      answerHistory.push({
        title: q.title,
        question: q.challenge.question,
        choices: q.challenge.choices,
        selectedIndex: selectedIndex,
        correctIndex: q.challenge.answer_index,
        wasCorrect: isCorrect,
        isBonus: true
      });

      if (isCorrect) {
        currentStreak++;
        totalCorrect++;
        bonusCorrect++;
        if (currentStreak > maxStreak) maxStreak = currentStreak;

        playSound('correct');
        spawnParticles('‚≠ê');
        const resultEl = document.createElement('div');
        resultEl.className = 'result correct';
        for (const key of Object.keys(virtues)) { virtues[key] += 1; }

        if (currentStreak >= 3) {
          resultEl.textContent = 'Bonus point! +1 to all virtues | üî• ' + currentStreak + ' streak!';
        } else {
          resultEl.textContent = 'Bonus point! +1 to all virtues';
        }
        questionContainer.appendChild(resultEl);
      } else {
        currentStreak = 0;
        playSound('wrong');
        shakeScreen();
        const resultEl = document.createElement('div');
        resultEl.className = 'result incorrect';
        const correct = q.challenge.choices[q.challenge.answer_index];
        resultEl.textContent = difficulty === 'easy' ? 'Not quite ‚Äî the answer was: ' + correct : 'Not quite!';
        questionContainer.appendChild(resultEl);
      }
      updateStreakDisplay();
      updateProfile();
      setTimeout(() => {
        bonusIndex++;
        isAnswerSubmitted = false;
        loadBonusQuest();
      }, 2000);
    }

    function endGame() {
      clearSavedProgress();
      gameScreen = "done";
      stopTimer();
      updateScreen();
      saintName.textContent = saints.find(s => s.id === currentSaint).name;

      // Score display
      const totalScore = Object.values(virtues).reduce((a, b) => a + b, 0);
      document.getElementById('score-display').textContent = 'Total Score: ' + totalScore + ' virtue points';
      document.getElementById('streak-summary').textContent =
        totalCorrect + '/' + totalQuestions + ' correct | Best streak: ' + maxStreak;

      // Check for new personal best
      const prevScores = safeGetJSON('saintQuestScores', {});
      const prevBest = prevScores[currentSaint] || 0;
      document.getElementById('new-record').style.display = totalScore > prevBest ? 'block' : 'none';

      // Draw radar chart
      drawRadarChart();

      // Display final virtues using DOM API
      finalProfile.innerHTML = '';
      for (const [key, value] of Object.entries(virtues)) {
        if (value > 0) {
          const span = document.createElement('span');
          span.className = 'virtue-badge v-' + key.toLowerCase();
          span.textContent = key + ': ' + value;
          finalProfile.appendChild(span);
          finalProfile.appendChild(document.createTextNode(' '));
        }
      }

      // Save high score
      saveHighScore();

      // Check and display achievements
      checkAndUnlockAchievements();

      // Build answer review
      buildReviewSection();

      // Daily challenge share
      if (isDailyChallenge) {
        saveDailyResult(totalScore);
        buildDailyShare(totalScore);
      }

      // Celebration!
      playSound('fanfare');
      spawnParticles('üèÜ');
      showBalloons();
    }

    function updateProfile() {
      profileContent.innerHTML = '';
      const saint = saints.find(s => s.id === currentSaint);
      const wrapper = document.createElement('div');
      wrapper.style.textAlign = 'center';

      const avatarEl = document.createElement('div');
      avatarEl.style.fontSize = '50px';
      avatarEl.textContent = saint.avatar;
      wrapper.appendChild(avatarEl);

      const nameEl = document.createElement('b');
      nameEl.textContent = saint.name;
      wrapper.appendChild(nameEl);

      const hr = document.createElement('hr');
      hr.style.margin = '15px 0';
      wrapper.appendChild(hr);

      for (const [key, value] of Object.entries(virtues)) {
        if (value > 0) {
          const span = document.createElement('span');
          span.className = 'virtue-badge v-' + key.toLowerCase();
          span.textContent = key + ': ' + value;
          wrapper.appendChild(span);
        }
      }

      profileContent.appendChild(wrapper);
    }

    function updateScreen() {
      const introScreen = document.getElementById('intro-screen');
      // Hide all screens
      selectScreen.classList.remove('active');
      playScreen.classList.remove('active');
      doneScreen.classList.remove('active');
      introScreen.classList.remove('active');

      if (gameScreen === "select") {
        selectScreen.classList.add('active');
      } else if (gameScreen === "intro") {
        introScreen.classList.add('active');
      } else if (gameScreen === "play") {
        playScreen.classList.add('active');
        const questList = currentQuests;
        const progress = (currentCheckpoint / questList.length) * 100;
        progressBar.style.width = progress + '%';
        progressText.textContent = `Chapter ${currentCheckpoint + 1} of ${questList.length}`;
      } else if (gameScreen === "done") {
        doneScreen.classList.add('active');
      }
    }

    function showBalloons() {
      balloonsEl.style.opacity = '1';

      for (let i = 0; i < 30; i++) {
        const balloon = document.createElement('div');
        balloon.className = 'balloon';
        balloon.textContent = 'üéà';
        balloon.style.left = Math.random() * 100 + 'vw';
        balloon.style.animationDuration = (Math.random() * 10 + 5) + 's';
        balloon.style.animationDelay = Math.random() * 5 + 's';
        balloonsEl.appendChild(balloon);
      }
    }

    function saveHighScore() {
      const scores = safeGetJSON('saintQuestScores', {});
      const score = Object.values(virtues).reduce((acc, val) => acc + val, 0);
      scores[currentSaint] = scores[currentSaint] || 0;

      if (score > scores[currentSaint]) {
        scores[currentSaint] = score;
        localStorage.setItem('saintQuestScores', JSON.stringify(scores));
      }
    }

    // === New Feature Functions ===

    // Build/rebuild saint selection grid with high scores
    function rebuildSaintGrid() {
      const saintGrid = document.getElementById('saint-grid');
      saintGrid.innerHTML = '';
      const scores = safeGetJSON('saintQuestScores', {});

      saints.forEach(s => {
        const card = document.createElement('div');
        card.className = 'saint-card';
        card.onclick = () => selectSaint(s.id);

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = s.avatar;
        card.appendChild(avatar);

        const h3 = document.createElement('h3');
        h3.textContent = s.name;
        card.appendChild(h3);

        const p = document.createElement('p');
        const i = document.createElement('i');
        i.textContent = 'Virtues: ' + s.virtues.join(', ');
        p.appendChild(i);
        card.appendChild(p);

        // High score display
        if (scores[s.id]) {
          const scoreBadge = document.createElement('div');
          scoreBadge.className = 'high-score-badge';
          scoreBadge.textContent = 'üèÜ Best: ' + scores[s.id];
          card.appendChild(scoreBadge);
        }

        saintGrid.appendChild(card);
      });

      // Total score display
      const totalAll = Object.values(scores).reduce((a, b) => a + b, 0);
      const existing = document.getElementById('total-score-display');
      if (existing) existing.remove();
      if (totalAll > 0) {
        const totalEl = document.createElement('div');
        totalEl.id = 'total-score-display';
        totalEl.style.cssText = 'text-align: center; color: var(--accent-gold); font-size: 1.1em; margin-top: 15px; font-weight: bold;';
        totalEl.textContent = '‚≠ê Total Virtue Points: ' + totalAll;
        saintGrid.parentElement.insertBefore(totalEl, saintGrid.nextSibling);
      }
    }

    // Achievement display on select screen
    function buildAchievementsDisplay() {
      const container = document.getElementById('achievements-display');
      container.innerHTML = '';
      const achievements = safeGetJSON('saintQuestAchievements', {});
      const unlocked = achievements.unlockedIds || [];

      const header = document.createElement('h3');
      header.textContent = 'üèÖ Achievements (' + unlocked.length + '/' + achievementDefs.length + ')';
      header.style.marginBottom = '15px';
      container.appendChild(header);

      const grid = document.createElement('div');
      grid.className = 'achievements-grid';

      achievementDefs.forEach(def => {
        const badge = document.createElement('div');
        badge.className = 'achievement-badge ' + (unlocked.includes(def.id) ? 'unlocked' : 'locked');
        badge.title = unlocked.includes(def.id) ? def.desc : '???';

        const icon = document.createElement('div');
        icon.style.fontSize = '2em';
        icon.textContent = def.icon;
        badge.appendChild(icon);

        const name = document.createElement('div');
        name.style.fontWeight = 'bold';
        name.textContent = def.name;
        badge.appendChild(name);

        const desc = document.createElement('div');
        desc.style.cssText = 'font-size: 0.75em; opacity: 0.7;';
        desc.textContent = unlocked.includes(def.id) ? def.desc : '???';
        badge.appendChild(desc);

        grid.appendChild(badge);
      });

      container.appendChild(grid);
    }

    // Check achievements at end of game
    function checkAndUnlockAchievements() {
      const achievements = safeGetJSON('saintQuestAchievements', {});
      const stats = safeGetJSON('saintQuestStats', {});

      if (!achievements.unlockedIds) achievements.unlockedIds = [];
      if (!stats.completedSaints) stats.completedSaints = {};

      stats.completedSaints[currentSaint] = true;

      const checkData = {
        justCompleted: true,
        totalCorrect,
        totalQuestions,
        completedSaints: stats.completedSaints,
        completedOnHard: difficulty === 'hard',
        endVirtues: { ...virtues },
        maxStreak,
        bonusCorrect
      };

      const newlyUnlocked = [];
      achievementDefs.forEach(def => {
        if (!achievements.unlockedIds.includes(def.id) && def.check(checkData)) {
          achievements.unlockedIds.push(def.id);
          newlyUnlocked.push(def);
        }
      });

      localStorage.setItem('saintQuestAchievements', JSON.stringify(achievements));
      localStorage.setItem('saintQuestStats', JSON.stringify(stats));

      // Show unlocked achievements on done screen
      const doneAch = document.getElementById('done-achievements');
      doneAch.innerHTML = '';
      if (newlyUnlocked.length > 0) {
        const header = document.createElement('h3');
        header.textContent = 'üéâ Achievements Unlocked!';
        header.style.marginBottom = '10px';
        doneAch.appendChild(header);
      }
      const achGrid = document.createElement('div');
      achGrid.className = 'achievements-grid';
      achievements.unlockedIds.forEach(id => {
        const def = achievementDefs.find(d => d.id === id);
        if (!def) return;
        const badge = document.createElement('div');
        badge.className = 'achievement-badge unlocked';
        const isNew = newlyUnlocked.some(n => n.id === id);
        if (isNew) badge.style.boxShadow = '0 0 15px rgba(212, 175, 55, 0.5)';

        const icon = document.createElement('div');
        icon.style.fontSize = '1.5em';
        icon.textContent = def.icon;
        badge.appendChild(icon);

        const name = document.createElement('div');
        name.style.fontWeight = 'bold';
        name.textContent = def.name;
        badge.appendChild(name);

        achGrid.appendChild(badge);
      });
      doneAch.appendChild(achGrid);

      // Toast for newly unlocked
      newlyUnlocked.forEach((ach, i) => {
        setTimeout(() => {
          const toast = document.createElement('div');
          toast.className = 'achievement-toast';
          const iconEl = document.createElement('span');
          iconEl.style.fontSize = '2em';
          iconEl.textContent = ach.icon;
          toast.appendChild(iconEl);
          const textEl = document.createElement('div');
          const line1 = document.createElement('div');
          line1.textContent = 'Achievement Unlocked!';
          line1.style.fontSize = '0.85em';
          textEl.appendChild(line1);
          const line2 = document.createElement('strong');
          line2.textContent = ach.name;
          textEl.appendChild(line2);
          toast.appendChild(textEl);
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 3500);
        }, i * 1500);
      });
    }

    // Build answer review section
    function buildReviewSection() {
      const container = document.getElementById('review-section');
      container.innerHTML = '';

      const summary = document.createElement('p');
      summary.style.cssText = 'text-align: center; margin-bottom: 15px;';
      summary.textContent = 'You got ' + totalCorrect + ' out of ' + totalQuestions + ' correct';
      container.appendChild(summary);

      answerHistory.forEach((entry, idx) => {
        const card = document.createElement('div');
        card.className = 'review-card ' + (entry.wasCorrect ? 'review-correct' : 'review-wrong');

        const title = document.createElement('strong');
        title.textContent = (idx + 1) + '. ' + entry.title + (entry.isBonus ? ' (Bonus)' : '');
        card.appendChild(title);

        const question = document.createElement('p');
        question.textContent = entry.question;
        question.style.cssText = 'margin: 8px 0; font-size: 0.95em;';
        card.appendChild(question);

        if (entry.wasCorrect) {
          const msg = document.createElement('p');
          msg.style.color = '#4CAF50';
          msg.textContent = '‚úÖ ' + entry.choices[entry.correctIndex];
          card.appendChild(msg);
        } else {
          const yours = document.createElement('p');
          yours.style.color = '#F44336';
          yours.textContent = '‚ùå Your answer: ' + (entry.selectedIndex >= 0 ? entry.choices[entry.selectedIndex] : 'Time expired');
          card.appendChild(yours);

          const correct = document.createElement('p');
          correct.style.color = '#4CAF50';
          correct.textContent = '‚úÖ Correct: ' + entry.choices[entry.correctIndex];
          card.appendChild(correct);
        }

        container.appendChild(card);
      });
    }

    function toggleReview() {
      const section = document.getElementById('review-section');
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }

    // Daily Challenge
    function startDailyChallenge() {
      const today = dateSeed();
      const dailyData = safeGetJSON('saintQuestDaily', {});

      if (dailyData.lastDate === today) {
        const el = document.getElementById('daily-status');
        el.textContent = '‚úÖ Already completed today! Score: ' + dailyData.lastScore + '. Come back tomorrow!';
        return;
      }

      const rng = seededRandom(today);
      const saintIndex = Math.floor(rng() * saints.length);
      const dailySaint = saints[saintIndex].id;
      const allQuests = quests[dailySaint];
      const shuffled = seededShuffle(allQuests, rng);
      const dailyQuests = shuffled.slice(0, 5);

      isDailyChallenge = true;
      currentSaint = dailySaint;
      currentCheckpoint = 0;
      inBonusRound = false;
      bonusIndex = 0;
      virtues = {"Faith": 0, "Mercy": 0, "Courage": 0, "Wisdom": 0};
      currentQuests = dailyQuests;
      currentStreak = 0;
      maxStreak = 0;
      totalCorrect = 0;
      totalQuestions = 0;
      bonusCorrect = 0;
      answerHistory = [];
      difficulty = 'normal';

      // Show intro
      const saint = saints.find(s => s.id === dailySaint);
      document.getElementById('intro-avatar').textContent = saint.avatar;
      document.getElementById('intro-name').textContent = 'üìÖ Daily Challenge: ' + saint.name;
      document.getElementById('intro-quote').textContent = '"' + (saintQuotes[dailySaint] || '') + '"';
      const introVirtues = document.getElementById('intro-virtues');
      introVirtues.innerHTML = '';
      saint.virtues.forEach(v => {
        const span = document.createElement('span');
        span.className = 'virtue-badge v-' + v.toLowerCase();
        span.textContent = v;
        introVirtues.appendChild(span);
      });
      gameScreen = "intro";
      updateScreen();
    }

    // Override bonus round for daily: skip it (only 5 questions)
    const originalStartBonusRound = startBonusRound;
    startBonusRound = function() {
      if (isDailyChallenge) {
        endGame();
        return;
      }
      originalStartBonusRound();
    };

    function saveDailyResult(score) {
      const today = dateSeed();
      localStorage.setItem('saintQuestDaily', JSON.stringify({
        lastDate: today,
        lastScore: score
      }));
    }

    function buildDailyShare(score) {
      const shareDiv = document.getElementById('daily-share');
      shareDiv.innerHTML = '';

      const d = new Date();
      const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      const saintObj = saints.find(s => s.id === currentSaint);
      const shareText = '‚öîÔ∏è Saint Quest Daily - ' + dateStr + '\n' +
        saintObj.name + '\n' +
        'Score: ' + score + ' | ' + totalCorrect + '/' + totalQuestions + ' correct\n' +
        'Streak: ' + maxStreak + '\n' +
        Object.entries(virtues).map(([k, v]) => k + ': ' + v).join(' | ');

      const btn = document.createElement('button');
      btn.className = 'btn btn-secondary';
      btn.textContent = 'üìã Copy Daily Result';
      btn.onclick = () => {
        navigator.clipboard.writeText(shareText).then(() => {
          btn.textContent = '‚úÖ Copied!';
          setTimeout(() => { btn.textContent = 'üìã Copy Daily Result'; }, 2000);
        }).catch(() => {
          btn.textContent = 'Copy not supported';
        });
      };
      shareDiv.appendChild(btn);
    }

    function updateDailyStatus() {
      const el = document.getElementById('daily-status');
      const btn = document.getElementById('daily-challenge-btn');
      const dailyData = safeGetJSON('saintQuestDaily', {});

      if (dailyData.lastDate === dateSeed()) {
        el.textContent = '‚úÖ Completed today! Score: ' + dailyData.lastScore;
        btn.style.opacity = '0.6';
      } else {
        el.textContent = 'A new challenge awaits!';
        btn.style.opacity = '1';
      }
    }

    // Initial setup
    showResumePrompt();
    rebuildSaintGrid();
    buildAchievementsDisplay();
    updateDailyStatus();
    updateScreen();
  </script>
</body>
</html>